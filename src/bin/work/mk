#!/bin/bash

# feature #
# 1 add make system.
# 2.check kernel version.
# 3.add creat new project.

source ~/.bin/lib/lib.work
source ~/.bin/lib/lib.misc

function guess_obj()
{
        source $1
        # kernel
        [ -d "arch" -a -d "kernel" ] && { echo $kernel; return; }
        # uboot
        [ -d "arch" -a -d "spl" ] && { echo $uboot; return; }

        # if [ -d ".git" ]; then
        # fi

        if [ -d ".repo" ]; then
                cd .repo/manifests
        # manhattan
                [ -n "$(git remote -v | grep -io 'manhattan')" ] && { echo $manhattan; return; }
        fi
}

function checkver()
{
        [ -f 'Makefile' ] && {
                eval $(head 'Makefile' -n 3 | sed 's/ //g')
                echo version = $VERSION'.'$PATCHLEVEL'.'$SUBLEVEL >&2
        }
}

function mkinit()
{
        DEST=$(guess_obj "$VGLD_MKDATA/cfg")
        [ -z "$DEST" ] && DEST=$(showlist_with_value "$VGLD_MKDATA/cfg" "what project type do you want init")
	if [ ! -f ".$DEST" ]; then
                cp "$VGLD_MKDATA/$DEST" ".$DEST"
                ./".$DEST" init
        else
                return 1
        fi
}

function mkn()
{
        cd $HOME/hub
        [ 'x'$(cat .working_state) == 'x1' ] && { echo 'project syncing! Please wait little time~' >&2; exit; }
        ls_dir 1 > .project_dir_have
        echo 
        echo -n 'How about this project:  >>> '
        read summary
        DEST=$(showlist_with_value ".project_dir_have" "Please chosen one project:")
        # cat .project_dir_have
        cd - 1>/dev/null
	if [ -n "$DEST" ]; then
                # echo $DEST
                # echo $summary
                mkdir $summary
                echo "copying ......"
                cp -arpdl $HOME/hub/$DEST $summary
                cd $summary/$DEST && mk
        fi
}

function mkmain() {
        # goto project root directory if possible.
        cd_proj

        # creat new project
        get_param '-c' $@
        [ $? -eq 0 ] && { mkn; return 0; }

        # check kernel version.
        get_param '-v' $@
        [ $? -eq 0 ] && { checkver; return 0; }

        # project init a make system.
	[ ! -f ".project_info" ] && { mkinit && echo "init ok" >&2; return 0; }

	local value=
	local key=
	while read line; do
		if [ -f ".${line#*=}" ]; then
			value=".${line#*=}"
			key=${line%%=*}
			break
		fi
	done < "$VGLD_MKDATA/cfg"

	if [ -n "value" ]; then
		# echo "this's maybe a $key project" >&2
		./$value $@
		return 0
	else
		echo "NO PROJECT DIR" >&2
		return 1
	fi
}

mkmain $@
