#!/bin/bash

function git_cover() {
	local BAKDIR=''
	BAKDIR=${1%\/*}/git_bak/${1##*\/}/$2
	if [ -d "$BAKDIR" ];then
		cp -rf $BAKDIR/* $1
	else
		echo "NO BAKDIR"
	fi
	exit
}

function git_bak() {

project_name=${1##*\/}
project_dir=../bacccc

mkdir $project_dir
mkdir $project_dir/$project_name

>"$project_name.vk"
echo "project_name=$project_name" >> "$project_dir/$project_name.vk"
echo "need_clone=1" >> "$project_dir/$project_name.vk"
remote=$(git remote -v | grep -s '(fetch)'| awk '{print $2}')
echo "remote=$remote" >> "$project_dir/$project_name.vk"
branch=$(git branch | grep "*" | awk '{print $2}')
echo "branch=$branch" >> "$project_dir/$project_name.vk"
commit=$(git log --oneline -1 | awk '{print $1}')
echo "commit=$commit" >> "$project_dir/$project_name.vk"

#echo >> "$project_dir/$project_name.add"
#echo >> "$project_dir/$project_name.modify"
#echo >> "$project_dir/$project_name.delete"

git diff HEAD > $project_dir/$project_name.patch

exit
	local file
	local mark
	> git-push.sh
	git status -s | {
		while read line; do
			[ -n "$line" -a "${line% *}" = "??" ] && {
				line=${line##* }

				file=$line
				[ "${file:0-1}" == "/" ] && file=${file%/*}
				file=${file##*/}

# Untracked files:

#   .project_info
#   .tmp
#   drivers/video/jz_lcd/jz_mipi_dsi/#jz_mipi_dsi.c#
#   git-push.sh
#   haha.sh
#   tmp
				[ "$mark" -eq 1 ] && echo "git add $line" >> git-push.sh
			}
		done
	}


    local dirname=
    local lastmmit=
    local branch=
	local BAKDIR=''
	local FILE=''
	local DIR_T=''
	local LINE=''
	local NUM=0

	BAKDIR=${1%\/*}/git_bak/${1##*\/}/${1##*\/}_$(date +%Y%m%d_%H-%M)
	[ $# -eq 2 ] && BAKDIR=$BAKDIR-$2

	if [ -d "$BAKDIR" ]; then
		rm $BAKDIR/ -rf
		rm $BAKDIR.tar.gz
		echo rm $BAKDIR
	fi

	echo baking......
	mkdir -p $BAKDIR
	[ $# -eq 2 ] && make_git_push_file $BAKDIR


	while read LINE; do
		if [[ "$LINE" =~ "git add" ]]; then
			FILE=${LINE##* }

			[[ "$FILE" =~ "/" ]] && {
				DIR_T=${FILE%/*} && mkdir -p $BAKDIR/$DIR_T/
				[ ${FILE:0-1} = "/" ] && cp -rf $1/$FILE/* $BAKDIR/$DIR_T/ || cp $1/$FILE $BAKDIR/$DIR_T/
			} || {
				cp $1/$FILE $BAKDIR/
			}
			NUM=$[$NUM+1]
		fi
	done < "$1/git-push.sh"
	cd ${BAKDIR%\/*}
	FILE=${BAKDIR##*\/}
	tar -Pzcf $FILE.tar.gz $FILE
	echo cp $NUM "files finished"
}

PROJECT_DIR_NAME=`getdir_git_repo | awk '{print $1}'`
PROJECT_DIR=`getdir_git_repo | awk '{print $2}'`

cd $PROJECT_DIR

if [ -n "$PROJECT_DIR_NAME" -a $# -gt 0 ];then
	if [ $1 == "bak" ]; then
		[ $# -eq 2 ] && git_bak $PROJECT_DIR $2 || git_bak $PROJECT_DIR
	elif [ $1 == "cover" ]; then
		[ $# -eq 2 ] && git_cover $PROJECT_DIR $2
	fi
fi

