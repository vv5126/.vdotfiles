#!/bin/bash

# 每台服务器上运行一份,
# 功能: 处理琐事.

# if new 
# add new task 





TASKDIR=$HOME/vtask
VHELPER_LOG=$TASKDIR/log
JOBDIR=$TASKDIR/jobs
tasklist=""

function tasklist_reset() {
    tasklist="$(ls $TASKDIR | grep -v '\/$ -')"
    echo tasklist = $tasklist
}

function tasklist_check() {
    if [ "x$taskchange" != "x$(stat $TASKDIR -c %y)" ]; then
        taskchange="$(stat $TASKDIR -c %y)"
        tasklist_reset
    fi
}

function service_timer() {
    sleep 60
    kill -100 server_main
}

function _log() {
    echo "$@" >> $VHELPER_LOG/$(date -%h).log
}

function service_job() {
    local job
    local jobs="$(ls $JOBDIR)"
    for job in jobs; do
        job="$(cat $JOBDIR/job)"
    done
}



function asd() {
    while [ 1 -eq 1 ]; do
        sleep 5
        tasklist_check
    done
}

function boot_check() {
    [ "$(ps -uc | grep -c "${0##*/}" -)" -gt 2 ] && { echo have!; exit; }
}

function vhelper_main() {
    boot_check

    trap 'boot_check' 32
    trap 'service_job' 33
    # trap 
    # trap 

    while true; do
        sleep 10 &
        wait
    done
}

vhelper_main



