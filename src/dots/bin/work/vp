#!/bin/bash

source ~/.bin/lib/lib.base
source ~/.bin/lib/lib.work
source ~/.bin/lib/lib.misc

host=user@192.168.4.150
local_home=$(ssh $host "pwd")
# adb="$local_home/.vdotfiles/src/dots/bin/local/adb"
adb="/usr/bin/adb"

function install_apk() {
    local src=$1
    local file=${src##*/}
    local ret=0

    scp $src $host:/tmp > /dev/null

    ssh $host "$adb remount" > /dev/null 2>&1
    ssh $host "$adb install -r /tmp/$file" > /dev/null 2>&1
    [ $? -eq 0 ] && ret=0 || ret=1
    ssh $host "$adb shell sync" > /dev/null 2>&1
    ssh $host "rm /tmp/$file" > /dev/null 2>&1
    return $ret

}

function push_to_board() {
    local src=$1
    local dst=$2
    local file=${src##*/}
    local ret=0

    scp -r $src $host:/tmp > /dev/null

    ssh $host "$adb remount" > /dev/null 2>&1
    ssh $host "$adb push /tmp/$file $dst" > /dev/null 2>&1
    [ $? -eq 0 ] && ret=0 || { ret=1; ssh $host "$adb push /tmp/$file $dst"; }
    ssh $host "$adb shell sync" > /dev/null 2>&1
    ssh $host "rm /tmp/$file" > /dev/null 2>&1
    return $ret
}


[ $# -eq 0 -o $# -gt 2 ] && exit

if [ -d "$1" ]; then
    file="$1"
elif [ -d "$(getdir .repo)/$1" ]; then
        file="$(getdir .repo)/$1"
elif [ -f "$1" ]; then
    file="$1"
elif [ -f "$(getdir .repo)/$1" ]; then
        file="$(getdir .repo)/$1"
fi

if [ $# -eq 2 ]; then
    dir="$2"
else
    if [[ "$file" =~ 'system' ]]; then
        cd_proj
        case "$(guess_obj)" in
            'android')
                dir="/system/${dir%/*}"
                ;;
            *)
                dir="/${1##*/system/}"
                dir="${dir%/*}"
                ;;
        esac
    fi
fi

[ -z "$file" -o -z "$dir" ] && { echo miss things; exit 255; }

if [ "${file:0-4}" == '.apk' ]; then
    install_apk "$file"
else
    push_to_board "$file" "$dir"
fi
[ $? == 0 ] && echo done! || { debug=1; echo fail!; }

debug echo file = $file
debug echo dir = $dir
