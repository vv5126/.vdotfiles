#!/bin/bash

# feature #
# 1 add make system.
# 2.check kernel version.
# 3.add creat new project.

source ~/.bin/lib/lib.base
source ~/.bin/lib/lib.work
source ~/.bin/lib/lib.misc

function try_get_obj()
{
        source $1
        # kernel
        [ -d "arch" -a -d "kernel" ] && { echo $kernel; return; }
        # uboot
        [ -d "arch" -a -d "spl" ] && { echo $uboot; return; }
        # mozart
        [ -d "mozart" ] && { echo $mozart; return; }
        [ -d "shairport" -a -d "dlna" ] && { echo $mozart; return; }

        if [ -d ".git" ]; then
            # mozart
            [ -n "$(git remote -v | grep -io 'mozart')" ] && { echo $mozart; return; }
        fi

        if [ -d ".repo" ]; then
                cd .repo/manifests
        # manhattan
                [ -n "$(git remote -v | grep -io 'manhattan')" ] && { echo $manhattan; return; }
        fi
}

function checkver()
{
        [ -f 'Makefile' ] && {
                eval $(head 'Makefile' -n 3 | sed 's/ //g')
                echo version = $VERSION'.'$PATCHLEVEL'.'$SUBLEVEL >&2
        }
}

function mkinit()
{
        local dest=$(try_get_obj "$VGLD_MKDATA/cfg")
        rm -rf .pro && mkdir .pro

        # only for mozart now
        [ "$dest" == 'mzt.sh' -a -d "mozart" ] && cd mozart

        echo $dest
        [ -z "$dest" ] && dest=$(showlist_with_value "$VGLD_MKDATA/cfg" "what project type do you want init")
	if [ ! -f ".pro/.$dest" ]; then
                cp "$VGLD_MKDATA/$dest" ".pro/.$dest"
                ./.pro/".$dest" init
        else
                return 1
        fi
}

function mkn()
{
	local tmp=

        [ 'x'$(cat $HOME/work/hub/.working_state) == 'x1' ] && { echo 'project syncing! Please wait little time~' >&2; exit; }

        (cd $HOME/work/hub; ls_dir 1 > .project_dir_have)

        local dest=$(showlist_with_value "$HOME/work/hub/.project_dir_have" "Please chosen one project:")
	if [ -n "$dest" ]; then
                tmp=$dest\_$(date +%Y%m%d_%H%M)
                echo -n "copying ......"
                cp -arpdl $HOME/work/hub/$dest $tmp
                echo " done."
                cd $tmp && mk
        fi
}

function tagbuild() {
    find . -name '*.cc' -o -name '*.h' -o -name '*.c' > '/tmp/.cs_db'
    cscope -bkq -i '/tmp/.cs_db'
    # find . -name '*.cc' -o -name '*.h' -o -name '*.c' > 'cscope.files'
    # cscope -bkq
    # echo gen cscope done!
    # ctags -L /tmp/.cs_db
    [ -f 'tags' ] || ctags -R --file-scope=yes --langmap=c:+.h --languages=c,c++ --links=yes --c-kinds=+p --c++-kinds=+p --fields=+iaS --extra=+q
    # echo gen tag done!
}

function mkmain() {
        # goto project root directory if possible.
        export TRIGGER_DIR=$PWD
        cd_proj

        # creat new project
        get_param '-c' $@
        [ $? -eq 0 ] && { mkn; return 0; }

        # creat tag
        get_param '-t' $@
        [ $? -eq 0 ] && { tagbuild; return 0; }

        # check kernel version.
        get_param '-v' $@
        [ $? -eq 0 ] && { checkver; return 0; }

        # project init a make system.
	[ ! -f ".pro/project_info" ] && { mkinit && echo "init ok" >&2; return 0; }

	local value=
	local key=
	while read line; do
		if [ -f ".pro/.${line#*=}" ]; then
			value=".${line#*=}"
			key=${line%%=*}
			break
		fi
	done < "$VGLD_MKDATA/cfg"

	if [ -n "value" ]; then
		# echo "this's maybe a $key project" >&2
		./.pro/$value $@
		return 0
	else
		echo "NO PROJECT DIR" >&2
		return 1
	fi
}

mkmain $@
